# 4口独立控制USB3.0 HUB 设计文档

## 产品功能描述

本产品为一个 **4 口独立控制的 USB3.0 HUB**，具备以下特性：

1. 每个 USB 端口可独立控制运转或非运转状态，由上位机授权。
2. 支持键盘、鼠标、U 盘设备检测和上报，能够识别违禁或未知设备。
3. MCU（STM32F7）作为 Host 模式先检测设备型号与信息，授权通过后再切换给 PC 端。
4. PC端通过USB口提供供电。
5. USB 端口拔出后，默认关闭 HUB 功能，端口返回 MCU 掌控。
6. 上位机通过串口与 MCU 通信，实现授权、状态查询与端口控制，另外MCU的串口也需要通过转USB的方式接入电脑，和USB HUB都是一根线连接。

## 系统架构设计

### 主要功能模块

1. **主控制器模块**：STM32F7系列MCU
2. **USB HUB控制模块**：USB3.0 HUB控制芯片
3. **USB切换模块**：USB信号切换电路
4. **串口转USB模块**：MCU串口通信转USB接口
5. **电源管理模块**：5V转3.3V等电源转换
6. **设备检测模块**：USB设备识别和状态检测

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                           PC端                              │
└─────────────────────────┬───────────────────────────────────┘
                          │ USB Type-A 接口
                          ▼
                ┌─────────────────┐
                │   GL3525 HUB    │
                │  5路USB3.0控制器 │
                └─────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   端口1-4   │  │   CH340G    │  │  电源管理   │
│  用户端口   │  │ 串口转USB   │  │    模块     │
└─────────────┘  └─────────────┘  └─────────────┘
        │                 │
        ▼                 ▼ UART
┌─────────────┐  ┌─────────────────┐
│ TS3USB221×4 │  │  STM32F767VIT6  │
│  信号切换器 │  │    主控制器     │
└─────────────┘  └─────────────────┘
        │                 │
        ▼                 ▼ GPIO控制
┌─────────────┐  ┌─────────────────┐
│ 用户设备1-4 │  │   端口控制逻辑  │
└─────────────┘  └─────────────────┘
```

### 工作原理

1. PC通过USB线缆连接到设备，提供5V供电
2. STM32F7 MCU作为主控制器，管理整个系统
3. 当USB设备插入时，首先由MCU检测设备类型和信息
4. MCU通过串口转USB模块与上位机通信，请求授权
5. 授权通过后，MCU控制USB切换电路，将设备连接到PC端
6. 设备拔出后，端口自动返回MCU控制

## 原理图设计

### 1. 主控制器电路（STM32F7）

**核心器件：STM32F767VIT6**
- 封装：LQFP-100
- 主频：216MHz
- Flash：2MB
- RAM：512KB
- 支持USB OTG HS/FS

**外围电路：**
- 晶振电路：25MHz主晶振 + 32.768KHz RTC晶振
- 复位电路：外部复位按键 + 复位芯片
- 电源滤波：多组电源滤波电容
- 调试接口：SWD调试接口

### 2. USB HUB控制电路

**核心器件：GL3525**
- 5端口USB3.0 HUB控制器
- 支持USB3.0/2.0/1.1
- 内置电源管理
- 支持端口独立控制
- 端口1-4连接用户设备，端口5连接CH340G串口转USB

**配套电路：**
- USB3.0差分信号处理
- 端口保护电路
- 状态指示LED

### 3. USB信号切换电路

**核心器件：TS3USB221（每端口一个）**
- 高速USB2.0/3.0信号切换器
- 低导通电阻
- 支持MCU控制切换

**控制逻辑：**
- MCU通过GPIO控制切换器选择信号
- 默认连接到MCU端进行设备检测
- 授权后切换到PC端

### 4. 串口转USB电路

**核心器件：CH340G**
- USB转串口芯片
- 支持USB2.0全速
- 内置晶振
- 与MCU的UART接口连接
- USB端连接到GL3525的端口5
- 集成到HUB内部，实现PC端单线连接

### 5. 电源管理电路

**主要器件：**
- AMS1117-3.3：5V转3.3V线性稳压器
- 电源指示LED
- 电源滤波电容组
- 软启动电路

### 6. 设备检测电路

**检测功能：**
- USB设备插入检测（VBUS检测）
- 设备类型识别（通过USB描述符）
- 设备状态监控

## BOM清单（Bill of Materials）

### 主要器件

| 序号 | 器件名称 | 型号 | 封装 | 数量 | 单价(元) | 总价(元) | 供应商 | 备注 |
|------|----------|------|------|------|----------|----------|--------|---------|
| 1 | 主控MCU | STM32F767VIT6 | LQFP-100 | 1 | 45.00 | 45.00 | ST | 主控制器 |
| 2 | USB HUB控制器 | GL3525 | QFN-68 | 1 | 35.00 | 35.00 | Genesys | USB3.0 HUB |
| 3 | USB信号切换器 | TS3USB221 | MSOP-10 | 4 | 3.50 | 14.00 | TI | 每端口一个 |
| 4 | 串口转USB | CH340G | SOP-16 | 1 | 2.50 | 2.50 | WCH | 串口通信 |
| 5 | 电压稳压器 | AMS1117-3.3 | SOT-223 | 1 | 0.50 | 0.50 | AMS | 电源管理 |
| 6 | 主晶振 | 25MHz | HC-49S | 1 | 1.00 | 1.00 | - | 主时钟 |
| 7 | RTC晶振 | 32.768KHz | 3215 | 1 | 0.80 | 0.80 | - | 实时时钟 |
| 8 | USB连接器 | USB3.0 Type-A母座 | - | 5 | 2.00 | 10.00 | - | 4个下游+1个上游 |

### 无源器件

| 序号 | 器件名称 | 规格 | 封装 | 数量 | 单价(元) | 总价(元) | 备注 |
|------|----------|------|------|------|----------|----------|---------|
| 9 | 电阻 | 10KΩ | 0603 | 10 | 0.01 | 0.10 | 上拉电阻 |
| 10 | 电阻 | 1KΩ | 0603 | 8 | 0.01 | 0.08 | LED限流 |
| 11 | 电阻 | 22Ω | 0603 | 8 | 0.01 | 0.08 | USB阻抗匹配 |
| 12 | 电容 | 100nF | 0603 | 20 | 0.02 | 0.40 | 去耦电容 |
| 13 | 电容 | 10μF | 0805 | 5 | 0.05 | 0.25 | 电源滤波 |
| 14 | 电容 | 22pF | 0603 | 4 | 0.02 | 0.08 | 晶振负载 |
| 15 | 电感 | 2.2μH | 0805 | 4 | 0.10 | 0.40 | 电源滤波 |

### 其他器件

| 序号 | 器件名称 | 规格 | 数量 | 单价(元) | 总价(元) | 备注 |
|------|----------|------|------|----------|----------|---------|
| 16 | LED指示灯 | 绿色 | 5 | 0.05 | 0.25 | 状态指示 |
| 17 | LED指示灯 | 红色 | 1 | 0.05 | 0.05 | 电源指示 |
| 18 | 按键开关 | 轻触开关 | 1 | 0.20 | 0.20 | 复位按键 |
| 19 | 排针 | 2.54mm | 1 | 0.50 | 0.50 | SWD调试接口 |
| 20 | PCB板 | 4层板 | 1 | 30.00 | 30.00 | 主板 |

### 成本汇总

| 类别 | 小计(元) |
|------|----------|
| 主要器件 | 99.30 |
| 无源器件 | 1.39 |
| 其他器件 | 31.00 |
| **总计** | **141.69** |

**成本变化说明：**
- GL3525比GL3523增加约10元
- 换取PC端单线连接的便利性

*注：以上价格为参考价格，实际采购价格可能因批量、供应商等因素有所差异*

## 设计注意事项

### 1. PCB设计要点

- **层叠设计**：建议使用4层PCB，信号层-地层-电源层-信号层
- **阻抗控制**：USB3.0差分信号需要控制90Ω±10%阻抗
- **信号完整性**：高速信号走线需要等长处理，避免串扰
- **电源完整性**：多点去耦，电源平面完整
- **EMC设计**：适当的屏蔽和滤波措施

### 2. 软件设计要点

- **USB协议栈**：实现USB Host功能，支持设备枚举和识别
- **设备识别算法**：基于VID/PID和设备描述符进行设备分类
- **通信协议**：定义与上位机的通信协议格式
- **状态机管理**：端口状态切换的状态机设计
- **异常处理**：设备异常拔插的处理机制

### 3. 测试验证

- **功能测试**：各端口独立控制功能验证
- **兼容性测试**：不同类型USB设备的兼容性
- **性能测试**：USB3.0传输速度和稳定性
- **EMC测试**：电磁兼容性测试
- **可靠性测试**：长时间工作稳定性测试

## 扩展功能

### 可选增强功能

1. **设备白名单管理**：支持设备白名单配置
2. **数据加密**：敏感数据传输加密
3. **远程管理**：支持网络远程控制
4. **日志记录**：设备使用日志记录和查询
5. **固件升级**：支持在线固件升级

### 产品系列化

1. **2口版本**：简化版本，降低成本
2. **8口版本**：扩展版本，适用于更多端口需求
3. **工业级版本**：宽温度范围，增强可靠性
4. **Type-C版本**：支持USB Type-C接口

---

*本设计文档为初步方案，具体实施时需要根据实际需求进行详细设计和优化。*