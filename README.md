# 可独立授权的USB HUB
## 方案

好的，我帮你把整个 USB HUB 产品设计方案整理成一份完整文档，基于 **STM32F7 MCU + 方案 1（MCU Host 先检测，再授权切换给 PC）**，涵盖 **硬件架构、信号切换、MCU固件设计、上位机协议、器件选型、实现注意事项及测试用例**，形成可交付的产品设计文档。

### 1. 产品概述
本产品为一个 **4 口独立控制的 USB3.0 HUB**，具备以下特性：
1. 每个 USB 端口可独立控制运转或非运转状态，由上位机授权。
2. 支持键盘、鼠标、U 盘设备检测和上报，能够识别违禁或未知设备。
3. MCU（STM32F7）作为 Host 模式先检测设备型号与信息，授权通过后再切换给 PC 端。
4. PC端通过USB口提供供电。
5. USB 端口拔出后，默认关闭 HUB 功能，端口返回 MCU 掌控。
6. 上位机通过串口与 MCU 通信，实现授权、状态查询与端口控制， 另外MCU的串口也需要通过转USB的方式接入电脑，和USB HUB都是一根线连接。

### 2. 系统架构
#### 2.1 硬件架构

```
                 +----------------+
                 |   PC Host      |
                 +--------+-------+
                          |
                       Upstream
                          |
               +----------+----------+
               |      USB Hub        |
               |(控制端口电源+MUX)  |
               +----------+----------+
                          |
                 +--------+--------+
        +---------+--------+---------+---------+
        |USB Port 1        |USB Port 2       | ... |USB Port 4
        +-----------------+-----------------+-----+
        |   VBUS Switch    |   USB3 MUX      |
        |   Data Lines     |  (MCU/PC)       |
        +-----------------+-----------------+
                   |
              STM32F7 MCU
        (USB Host /检测/上报/切换)
```

#### 2.2 功能模块说明
1.**MCU STM32F7**
   * USB Host OTG 接口负责每口设备枚举和读取信息（HID/U盘序列号/扇区信息）。
   * 控制每口 USB VBUS 电源开关和高速数据 MUX。
   * 通过串口与上位机通信。

2.**USB3 数据切换器（MUX）**
   * 高速 SuperSpeed 差分对切换（MCU <-> PC）。
   * USB2 D+/D- 数据切换。

3.**每口 VBUS 电源开关**
   * 独立控制 USB 端口供电，支持限流与热关断。

4.**上位机软件**
   * 接收 MCU 上报设备信息。
   * 授权或拒绝设备接入。
   * 通知 MCU 切换端口给 PC 或回切 MCU。

### 3. MCU 固件设计
#### 3.1 端口状态机
每口 USB 端口状态如下：

| 状态                 | 描述                  |
| ------------------ | ------------------- |
| IDLE               | 空闲，未检测到设备           |
| PRESENCE\_DETECTED | 设备插入，MCU Host 通道被路由 |
| MCU\_INSPECTING    | MCU 枚举设备，读取信息       |
| AWAIT\_AUTH        | 上报上位机，等待授权          |
| AUTHORIZED         | 授权通过，端口切换给 PC       |
| DENIED/BLOCKED     | 拒绝访问，端口断开           |
| PC\_CONNECTED      | PC 枚举并接管设备          |
| PC\_DISCONNECTED   | PC 拔出，端口切回 MCU      |

#### 3.2 串口协议（示例 JSON）
* **MCU → 上位机**
```json
{ "event": "detected", "port": 1, "timestamp": 12345678, "usb_type": "mass_storage" }
{ "event": "inspect", "port": 1, "vid": "0xXXXX", "pid": "0xYYYY", "serial": "..." }
{ "event": "status", "port": 1, "state": "AUTHORIZED" }
```

* **上位机 → MCU**
```json
{ "cmd": "authorize", "port": 1 }
{ "cmd": "deny", "port": 1 }
{ "cmd": "force_disconnect", "port": 1 }
```

#### 3.3 MCU 功能流程
1. 设备插入 → MCU Host 枚举 → 上报上位机。
2. 上位机授权 → MCU 控制 MUX + VBUS → 切换端口给 PC。
3. PC 枚举成功 → MCU 记录端口状态。
4. PC 拔出或上位机断开 → MCU 切回 MCU Host。

### 4. 硬件选型

| 功能            | 推荐器件                          | 备注                             |
| ------------- | ----------------------------- | ------------------------------ |
| USB Host 控制器  | STM32F7 OTG HS                | MCU 自带 USB Host OTG            |
| USB3 高速数据 MUX | PI3USB30532                   | 控制 MCU ↔ PC 数据切换，支持 SuperSpeed |
| USB2 数据切换     | TS3USB30 或 TS3A47191          | 控制 D+/D- 切换                    |
| Per-port 电源开关 | USB Power Switch IC（限流，EN 控制） | 独立控制 VBUS，支持热关断                |
| 可选 SmartHub   | Microchip SmartHub 系列         | 集成端口管理，减少外部切换器件                |

### 5. 信号路由与切换逻辑
1.**初始状态**：所有端口 VBUS 断开，数据线切换至 MCU。
2.**设备插入**：端口切换 MCU Host，MCU 枚举设备。
3.**上位机授权**：
   * 打开 VBUS（设备供电）
   * 数据线切换给 PC 上行口
4.**PC 拔出或上位机命令断开**：
   * 数据线切换回 MCU
   * 可断开 VBUS（可选，根据策略）

### 6. MCU 固件注意事项
1. USB3 信号完整性：PCB 遵循差分阻抗控制、AC coupling、等长布线。
2. Host 切换时序：先断开 PC，再切 MCU；反向亦然。
3. 枚举 U 盘或 HID：需稳定的 USB Host 堆栈，支持 MSC/HID。
4. 异常处理：插拔、授权超时、切换失败等必须有回退策略。
5. 串口协议 ACK/NAK + 超时机制，保证 MCU 和上位机状态一致。

### 7. 测试用例

| 测试场景    | 期望结果                                   |
| ------- | -------------------------------------- |
| 插入 U 盘  | MCU 检测 → 上报 → 上位机授权 → 切换给 PC → PC 枚举成功 |
| 插入手机    | MCU 检测 → 上报 → 上位机拒绝 → 端口断开，PC 看不到      |
| PC 拔出设备 | MCU 接收到通知 → 切回 MCU Host → 端口待下次插入      |
| 多口同时操作  | 所有端口独立控制，切换和授权逻辑正常                     |
| 异常场景    | 切换失败或枚举超时 → 自动回退，状态记录并报警               |

### 8. 验收标准
1. 每口独立控制可行。
2. MCU 先枚举设备并上报，上位机授权后才切换到 PC。
3. PC 无法在未授权前访问设备。
4. 支持键盘、鼠标、U 盘检测、上报与控制。
5. USB 充电口稳定输出电流，允许充电。
6. 异常拔出、断电、插拔事件正确处理，系统状态一致。