# 5路USB3.0 HUB设计方案（集成串口转USB）

## 设计概述

本方案采用5路USB HUB芯片，将CH340G串口转USB模块集成到HUB内部，实现PC端只需一根USB线即可完成数据传输和控制通信。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                           PC端                              │
└─────────────────────────┬───────────────────────────────────┘
                          │ USB Type-A 接口
                          ▼
                ┌─────────────────┐
                │   GL3525 HUB    │
                │  5路USB3.0控制器 │
                └─────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   端口1-4   │  │   CH340G    │  │  电源管理   │
│  用户端口   │  │ 串口转USB   │  │    模块     │
└─────────────┘  └─────────────┘  └─────────────┘
        │                 │
        ▼                 ▼ UART
┌─────────────┐  ┌─────────────────┐
│ TS3USB221×4 │  │  STM32F767VIT6  │
│  信号切换器 │  │    主控制器     │
└─────────────┘  └─────────────────┘
        │                 │
        ▼                 ▼ GPIO控制
┌─────────────┐  ┌─────────────────┐
│ 用户设备1-4 │  │   端口控制逻辑  │
└─────────────┘  └─────────────────┘
```

## 主要器件选型

### 核心芯片

| 器件 | 型号 | 功能 | 封装 | 价格(元) |
|------|------|------|------|----------|
| USB HUB控制器 | GL3525 | 5路USB3.0 HUB | QFN-64 | 28.00 |
| 主控制器 | STM32F767VIT6 | ARM Cortex-M7 | LQFP-100 | 45.00 |
| 串口转USB | CH340G | USB转UART | SOP-16 | 2.50 |
| USB信号切换器 | TS3USB221A | 高速USB开关 | UQFN-10 | 3.20×4 |

### GL3525 USB HUB控制器详细规格

- **接口规格**：USB 3.0 SuperSpeed (5Gbps)
- **下游端口**：5个独立端口
- **上游端口**：1个连接PC
- **电源管理**：支持端口独立供电控制
- **工作电压**：3.3V核心，1.2V内核
- **工作温度**：-40°C ~ +85°C
- **封装**：QFN-64 (9mm×9mm)

## 详细电路设计

### 1. GL3525 USB HUB电路

```
                    GL3525 (QFN-64)
                   ┌─────────────────┐
    USB_UP_DP ─────│1   USB_UP    64│───── VDD33
    USB_UP_DM ─────│2             63│───── VDD12
    USB_UP_SSTXP ──│3             62│───── XTAL_OUT
    USB_UP_SSTXM ──│4             61│───── XTAL_IN
    USB_UP_SSRXP ──│5             60│───── RESET#
    USB_UP_SSRXM ──│6             59│───── TEST
                   │7             58│
    USB_DN1_DP ────│8   PORT1     57│───── USB_DN5_DP
    USB_DN1_DM ────│9             56│───── USB_DN5_DM
    USB_DN1_SSTXP ─│10            55│───── USB_DN5_SSTXP
    USB_DN1_SSTXM ─│11            54│───── USB_DN5_SSTXM
    USB_DN1_SSRXP ─│12            53│───── USB_DN5_SSRXP
    USB_DN1_SSRXM ─│13            52│───── USB_DN5_SSRXM
                   │14            51│
    USB_DN2_DP ────│15  PORT2     50│───── PRTPWR5#
    USB_DN2_DM ────│16            49│───── PRTPWR4#
                   │...           ...│
    PRTPWR1# ──────│32            33│───── PRTPWR2#
                   └─────────────────┘
```

**关键连接：**
- 端口1-4：连接到TS3USB221信号切换器
- 端口5：直接连接CH340G串口转USB模块
- 晶振：30MHz差分晶振
- 电源：3.3V主电源，1.2V内核电源

### 2. 端口分配方案

| 端口 | 连接对象 | 功能 | 控制方式 |
|------|----------|------|----------|
| 端口1 | TS3USB221 #1 | 用户USB设备1 | STM32 GPIO控制 |
| 端口2 | TS3USB221 #2 | 用户USB设备2 | STM32 GPIO控制 |
| 端口3 | TS3USB221 #3 | 用户USB设备3 | STM32 GPIO控制 |
| 端口4 | TS3USB221 #4 | 用户USB设备4 | STM32 GPIO控制 |
| 端口5 | CH340G | 串口通信 | 固定连接 |

### 3. 信号切换电路（每个端口）

```
                    TS3USB221A
                   ┌─────────────┐
    USB_HUB_DP ────│1  A_DP   10│───── USB_OUT_DP
    USB_HUB_DM ────│2  A_DM    9│───── USB_OUT_DM
    MCU_USB_DP ────│3  B_DP    8│───── VCC
    MCU_USB_DM ────│4  B_DM    7│───── OE#
    GND ───────────│5  GND     6│───── SEL
                   └─────────────┘
                            │     │
                            │     └── STM32_GPIO (端口选择)
                            └────────── STM32_GPIO (使能控制)
```

**控制逻辑：**
- SEL=0：连接到MCU（设备检测模式）
- SEL=1：连接到HUB（正常工作模式）
- OE#=0：开关使能
- OE#=1：开关禁用（高阻态）

### 4. CH340G串口转USB电路

```
                    CH340G (SOP-16)
                   ┌─────────────────┐
    GND ───────────│1   GND      16│───── VCC
    TXD ───────────│2   TXD      15│───── R232
    RXD ───────────│3   RXD      14│───── TNOW
    V3 ────────────│4   V3       13│───── CTS#
    USB_DP ────────│5   UD+      12│───── DSR#
    USB_DM ────────│6   UD-      11│───── RI#
    XI ────────────│7   XI       10│───── DCD#
    XO ────────────│8   XO        9│───── DTR#
                   └─────────────────┘
                            │     │
                            │     └── STM32_UART_TX
                            └────────── STM32_UART_RX
```

**连接说明：**
- USB_DP/DM：连接到GL3525的端口5
- TXD/RXD：连接到STM32的UART接口
- 晶振：12MHz外部晶振

## 电源管理设计

### 电源架构

```
PC USB 5V ──┬── 5V主电源轨
            │
            ├── LDO1 ──→ 3.3V ──┬── STM32F767
            │                   ├── CH340G
            │                   ├── TS3USB221×4
            │                   └── GL3525 I/O
            │
            ├── LDO2 ──→ 1.2V ──→ GL3525 Core
            │
            └── 端口电源控制 ──┬── 端口1 VBUS (5V)
                              ├── 端口2 VBUS (5V)
                              ├── 端口3 VBUS (5V)
                              └── 端口4 VBUS (5V)
```

### 端口电源控制电路

```
每个端口的电源控制：

5V ──┬── P-MOSFET ──┬── 端口VBUS输出
     │              │
     │              ├── 电流检测电阻 (0.1Ω)
     │              │
     └── 10kΩ       └── 过流保护IC (TPS2561)
         │
         └── STM32_GPIO (端口电源控制)
```

## 更新的BOM表

### 主要器件

| 序号 | 器件名称 | 型号 | 封装 | 数量 | 单价(元) | 总价(元) | 供应商 |
|------|----------|------|------|------|----------|----------|--------|
| 1 | USB3.0 HUB控制器 | GL3525 | QFN-64 | 1 | 28.00 | 28.00 | Genesys |
| 2 | 主控制器 | STM32F767VIT6 | LQFP-100 | 1 | 45.00 | 45.00 | ST |
| 3 | 串口转USB | CH340G | SOP-16 | 1 | 2.50 | 2.50 | WCH |
| 4 | USB信号切换器 | TS3USB221A | UQFN-10 | 4 | 3.20 | 12.80 | TI |
| 5 | 电源管理IC | TPS2561 | SOT-23-6 | 4 | 2.80 | 11.20 | TI |
| 6 | LDO稳压器 | AMS1117-3.3 | SOT-223 | 1 | 0.80 | 0.80 | AMS |
| 7 | LDO稳压器 | AMS1117-1.2 | SOT-223 | 1 | 0.80 | 0.80 | AMS |
| 8 | P-MOSFET | AO3401 | SOT-23 | 4 | 0.50 | 2.00 | AOS |

### 晶振和时钟

| 序号 | 器件名称 | 型号 | 封装 | 数量 | 单价(元) | 总价(元) |
|------|----------|------|------|------|----------|----------|
| 9 | 差分晶振 | 30MHz | 7×5mm | 1 | 8.00 | 8.00 |
| 10 | 晶振 | 25MHz | HC-49S | 1 | 1.50 | 1.50 |
| 11 | 晶振 | 12MHz | HC-49S | 1 | 1.20 | 1.20 |
| 12 | 32.768kHz晶振 | 32.768kHz | 3.2×1.5mm | 1 | 2.00 | 2.00 |

### 连接器

| 序号 | 器件名称 | 型号 | 数量 | 单价(元) | 总价(元) |
|------|----------|------|------|----------|----------|
| 13 | USB3.0 Type-A母座 | USB3.0-A-F | 5 | 3.50 | 17.50 |
| 14 | USB3.0 Type-A公头 | USB3.0-A-M | 1 | 2.80 | 2.80 |

### 阻容感器件

| 类型 | 规格 | 封装 | 数量 | 单价(元) | 总价(元) |
|------|------|------|------|----------|----------|
| 电阻 | 0Ω~10MΩ | 0603 | 50 | 0.02 | 1.00 |
| 电容 | 1pF~100μF | 0603/0805 | 80 | 0.05 | 4.00 |
| 电感 | 1μH~100μH | 0603/0805 | 10 | 0.30 | 3.00 |
| 磁珠 | 120Ω@100MHz | 0603 | 20 | 0.15 | 3.00 |

### 保护器件

| 序号 | 器件名称 | 型号 | 数量 | 单价(元) | 总价(元) |
|------|----------|------|------|----------|----------|
| 15 | ESD保护二极管 | PESD5V0S1BA | 20 | 0.80 | 16.00 |
| 16 | 自恢复保险丝 | PPTC 500mA | 5 | 1.20 | 6.00 |
| 17 | TVS二极管 | SMAJ5.0A | 5 | 1.50 | 7.50 |

### PCB和机械件

| 序号 | 器件名称 | 规格 | 数量 | 单价(元) | 总价(元) |
|------|----------|------|------|----------|----------|
| 18 | PCB板 | 4层板 100×80mm | 1 | 25.00 | 25.00 |
| 19 | 外壳 | ABS塑料外壳 | 1 | 15.00 | 15.00 |
| 20 | 螺丝 | M3×6mm | 4 | 0.10 | 0.40 |

**总成本估算：约 205.00 元**

## 软件设计要点

### STM32固件修改

1. **端口管理**：
   - 增加端口5的CH340G通信处理
   - 修改端口控制逻辑，支持5个端口

2. **通信协议**：
   - 保持原有UART通信协议不变
   - 增加端口5状态查询命令

3. **电源管理**：
   - 增加GL3525的电源控制
   - 优化端口电源时序控制

### 上位机软件修改

1. **界面更新**：
   - 显示5个端口状态（端口5固定为通信端口）
   - 用户只能控制端口1-4

2. **设备识别**：
   - 自动识别CH340G设备
   - 过滤掉端口5的设备信息

## 优势分析

### 技术优势
1. **单线连接**：PC端只需一根USB线
2. **集成度高**：所有功能集成在一个设备中
3. **成本可控**：相比独立方案增加约30-40元
4. **兼容性好**：支持USB3.0向下兼容

### 应用优势
1. **部署简单**：减少线缆管理复杂度
2. **可靠性高**：减少连接点，降低故障率
3. **便携性好**：适合移动办公场景
4. **扩展性强**：预留接口支持功能升级

## 设计注意事项

### 硬件设计
1. **信号完整性**：USB3.0差分信号需要严格阻抗控制
2. **电源设计**：GL3525需要稳定的1.2V和3.3V电源
3. **EMC设计**：增加滤波电路和屏蔽措施
4. **热设计**：GL3525发热较大，需要散热设计

### 软件设计
1. **端口管理**：确保端口5不被用户误操作
2. **异常处理**：增加GL3525异常检测和恢复
3. **性能优化**：优化USB枚举和切换时序

## 总结

5路USB HUB方案通过集成CH340G串口转USB模块，实现了PC端单线连接的目标。虽然成本相比4路方案有所增加，但在便利性和集成度方面有显著优势，特别适合对线缆管理有严格要求的应用场景。

该方案技术成熟，器件供应稳定，可以满足批量生产需求。