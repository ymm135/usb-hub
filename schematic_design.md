# USB3.0 HUB 原理图设计详细说明

## 1. 系统框图

### 1.1 整体连接架构

```
PC端
├── USB接口1 ──→ GL3523 USB3.0 HUB ──┬─── 用户端口1
│                                     ├─── 用户端口2
│                                     ├─── 用户端口3
│                                     └─── 用户端口4
│
└── USB接口2 ──→ CH340G串口转USB ──→ STM32F767 UART通信
```

### 1.2 详细系统框图

```
┌─────────────────────────────────────────────────────────────┐
│                           PC端                              │
└─────────────┬─────────────────────────┬─────────────────────┘
              │ USB接口1                │ USB接口2
              ▼                         ▼
    ┌─────────────────┐         ┌─────────────────┐
    │   GL3523 HUB    │         │    CH340G       │
    │   USB3.0控制器  │         │  串口转USB      │
    └─────────────────┘         └─────────────────┘
              │                         │ UART
              │                         ▼
    ┌─────────┼─────────┐    ┌─────────────────────┐
    │         │         │    │   STM32F767VIT6    │
    ▼         ▼         ▼    │     主控制器       │
┌───────┐ ┌───────┐ ┌───────┐│                     │
│ 端口1 │ │ 端口2 │ │ 端口3 ││  GPIO控制信号       │
└───────┘ └───────┘ └───────┘└─────────────────────┘
                              │ │ │ │
                              ▼ ▼ ▼ ▼
                        ┌─────────────────┐
                        │  TS3USB221×4    │
                        │   信号切换器    │
                        └─────────────────┘
                              │ │ │ │
                              ▼ ▼ ▼ ▼
                        ┌─────────────────┐
                        │   用户端口1-4   │
                        └─────────────────┘
```

### 1.3 连接说明

- **GL3523 USB HUB**：连接到PC的USB接口1，提供4路用户端口
- **CH340G串口转USB**：连接到PC的USB接口2，与STM32进行UART通信
- **STM32主控**：通过GPIO控制TS3USB221切换器，实现端口的独立控制
- **TS3USB221切换器**：每个用户端口配置一个，实现MCU检测和PC连接的切换

## 2. 系统框图更新

### 2.1 5路USB HUB系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                           PC端                              │
└─────────────────────────┬───────────────────────────────────┘
                          │ USB Type-A 接口
                          ▼
                ┌─────────────────┐
                │   GL3525 HUB    │
                │  5路USB3.0控制器 │
                └─────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   端口1-4   │  │   CH340G    │  │  电源管理   │
│  用户端口   │  │ 串口转USB   │  │    模块     │
└─────────────┘  └─────────────┘  └─────────────┘
        │                 │
        ▼                 ▼ UART
┌─────────────┐  ┌─────────────────┐
│ TS3USB221×4 │  │  STM32F767VIT6  │
│  信号切换器 │  │    主控制器     │
└─────────────┘  └─────────────────┘
        │                 │
        ▼                 ▼ GPIO控制
┌─────────────┐  ┌─────────────────┐
│ 用户设备1-4 │  │   端口控制逻辑  │
└─────────────┘  └─────────────────┘
```

## 3. 主控制器电路设计（STM32F767VIT6）

### 3.1 电源电路

```
VDD_MCU (3.3V)
    │
    ├── C1 (100nF) ──┤
    ├── C2 (100nF) ──┤
    ├── C3 (100nF) ──┤  (去耦电容，靠近MCU放置)
    ├── C4 (100nF) ──┤
    └── C5 (10μF)  ──┤
                     │
                    GND

VDDA (模拟电源 3.3V)
    │
    ├── L1 (2.2μH) ── C6 (100nF) ──┤
    └── C7 (10μF) ──────────────────┤
                                   │
                                  GND
```

### 2.2 时钟电路

```
主晶振电路 (25MHz):
PH0 ──── C8 (22pF) ──── X1 (25MHz) ──── C9 (22pF) ──── PH1
                           │                           │
                          GND                         GND

RTC晶振电路 (32.768KHz):
PC14 ── C10 (22pF) ── X2 (32.768KHz) ── C11 (22pF) ── PC15
                         │                            │
                        GND                          GND
```

### 2.3 复位电路

```
VDD (3.3V)
    │
    R1 (10KΩ)
    │
NRST ────────── SW1 (复位按键)
    │               │
    C12 (100nF)    GND
    │
   GND
```

### 2.4 调试接口

```
SWD调试接口:
Pin1: VDD (3.3V)
Pin2: SWDIO (PA13)
Pin3: GND
Pin4: SWCLK (PA14)
Pin5: GND
Pin6: SWO (PB3)
```

## 4. USB HUB控制电路（GL3525）

### 4.1 主要连接

```
GL3525引脚分配:

电源:
VDD33 (Pin 1,15,29,43) ── 3.3V
VDD18 (Pin 8,22,36,50) ── 1.8V (内部LDO输出)
GND (Pin 7,14,21,28,35,42,49,56) ── GND

上游USB3.0接口:
USB_DP (Pin 2) ── USB上游D+
USB_DM (Pin 3) ── USB上游D-
SSRX+ (Pin 4) ── USB上游RX+
SSRX- (Pin 5) ── USB上游RX-
SSTX+ (Pin 6) ── USB上游TX+
SSTX- (Pin 9) ── USB上游TX-

下游端口1:
DS1_DP (Pin 16) ── 端口1 D+
DS1_DM (Pin 17) ── 端口1 D-
DS1_SSRX+ (Pin 18) ── 端口1 RX+
DS1_SSRX- (Pin 19) ── 端口1 RX-
DS1_SSTX+ (Pin 20) ── 端口1 TX+
DS1_SSTX- (Pin 23) ── 端口1 TX-

下游端口2:
DS2_DP (Pin 30) ── 端口2 D+
DS2_DM (Pin 31) ── 端口2 D-
DS2_SSRX+ (Pin 32) ── 端口2 RX+
DS2_SSRX- (Pin 33) ── 端口2 RX-
DS2_SSTX+ (Pin 34) ── 端口2 TX+
DS2_SSTX- (Pin 37) ── 端口2 TX-

下游端口3:
DS3_DP (Pin 44) ── 端口3 D+
DS3_DM (Pin 45) ── 端口3 D-
DS3_SSRX+ (Pin 46) ── 端口3 RX+
DS3_SSRX- (Pin 47) ── 端口3 RX-
DS3_SSTX+ (Pin 48) ── 端口3 TX+
DS3_SSTX- (Pin 51) ── 端口3 TX-

下游端口4:
DS4_DP (Pin 58) ── 端口4 D+
DS4_DM (Pin 59) ── 端口4 D-
DS4_SSRX+ (Pin 60) ── 端口4 RX+
DS4_SSRX- (Pin 61) ── 端口4 RX-
DS4_SSTX+ (Pin 62) ── 端口4 TX+
DS4_SSTX- (Pin 65) ── 端口4 TX-

控制信号:
PRT_DIS1 (Pin 24) ── STM32 PB0 (端口1使能控制)
PRT_DIS2 (Pin 38) ── STM32 PB1 (端口2使能控制)
PRT_DIS3 (Pin 52) ── STM32 PB2 (端口3使能控制)
PRT_DIS4 (Pin 66) ── STM32 PB3 (端口4使能控制)

OVCUR1 (Pin 25) ── STM32 PC0 (端口1过流检测)
OVCUR2 (Pin 39) ── STM32 PC1 (端口2过流检测)
OVCUR3 (Pin 53) ── STM32 PC2 (端口3过流检测)
OVCUR4 (Pin 67) ── STM32 PC3 (端口4过流检测)
```

### 4.2 晶振电路

```
GL3525晶振 (25MHz):
XTAL1 (Pin 10) ── C13 (22pF) ── X3 (25MHz) ── C14 (22pF) ── XTAL2 (Pin 11)
                     │                         │
                    GND                       GND
```

### 4.3 端口5连接CH340G

```
GL3525端口5:
DS5_DP (Pin 70) ── CH340G UD+
DS5_DM (Pin 71) ── CH340G UD-
PRT_DIS5 (Pin 72) ── STM32 PB4 (端口5使能控制)
OVCUR5 (Pin 73) ── STM32 PC4 (端口5过流检测)
```

## 5. USB信号切换电路（TS3USB221）

### 5.1 端口1切换电路

```
TS3USB221 (U3) - 端口1:

VCC (Pin 1) ── 3.3V
GND (Pin 6) ── GND

OE (Pin 2) ── STM32 PD0 (切换使能)
S (Pin 3) ── STM32 PD1 (切换选择)

D+ 信号切换:
D1+ (Pin 4) ── GL3523 DS1_DP (来自HUB)
D2+ (Pin 5) ── STM32 PA11 (MCU USB OTG FS D+)
D+ (Pin 7) ── USB端口1 D+

D- 信号切换:
D1- (Pin 8) ── GL3523 DS1_DM (来自HUB)
D2- (Pin 9) ── STM32 PA12 (MCU USB OTG FS D-)
D- (Pin 10) ── USB端口1 D-

切换逻辑:
OE=1, S=0: 连接到MCU (D2+/D2-)
OE=1, S=1: 连接到HUB (D1+/D1-)
OE=0: 高阻态
```

### 4.2 端口2-4切换电路

```
端口2切换 (U4):
OE ── STM32 PD2
S ── STM32 PD3
D1+/D1- ── GL3523 DS2_DP/DS2_DM
D2+/D2- ── STM32 PB14/PB15 (USB OTG HS)
D+/D- ── USB端口2

端口3切换 (U5):
OE ── STM32 PD4
S ── STM32 PD5
D1+/D1- ── GL3523 DS3_DP/DS3_DM
D2+/D2- ── 通过GPIO模拟USB通信
D+/D- ── USB端口3

端口4切换 (U6):
OE ── STM32 PD6
S ── STM32 PD7
D1+/D1- ── GL3523 DS4_DP/DS4_DM
D2+/D2- ── 通过GPIO模拟USB通信
D+/D- ── USB端口4
```

## 6. 串口转USB电路（CH340G）

### 6.1 主要连接（连接到GL3525端口5）

```
CH340G (U7):

VCC (Pin 16) ── 3.3V
GND (Pin 1) ── GND

USB接口:
UD+ (Pin 3) ── GL3525 DS5_DP (端口5 D+)
UD- (Pin 4) ── GL3525 DS5_DM (端口5 D-)

串口接口:
TXD (Pin 2) ── STM32 PA9 (USART1_TX)
RXD (Pin 3) ── STM32 PA10 (USART1_RX)
RTS (Pin 13) ── STM32 PA11 (可选)
CTS (Pin 9) ── STM32 PA12 (可选)

控制信号:
DTR (Pin 12) ── 可用于MCU复位控制
DSR (Pin 10) ── 状态指示

晶振:
XI (Pin 5) ── 内置晶振，无需外接
XO (Pin 6)
```

## 7. 电源管理电路

### 7.1 主电源电路

```
USB 5V输入:
VBUS (USB上游) ── F1 (保险丝 2A) ── D1 (肖特基二极管) ── VIN (5V)
                                      │
                                      C15 (470μF) ── GND

3.3V稳压:
VIN (5V) ── AMS1117-3.3 ── VDD (3.3V)
              │               │
              C16 (100nF)     C17 (220μF)
              │               │
             GND             GND

电源指示:
VDD (3.3V) ── R2 (1KΩ) ── LED1 (红色) ── GND
```

### 7.2 端口电源控制

```
端口1电源控制:
VBUS ── Q1 (P-MOS) ── USB端口1 VBUS
         │
         R3 (10KΩ) ── STM32 PE0 (端口1电源控制)
         │
        VDD

端口2-5电源控制:
类似端口1，分别由STM32 PE1, PE2, PE3, PE4控制

端口5特殊说明:
- 端口5专用于CH340G供电
- 通常保持常开状态
- 可通过软件控制重启CH340G
```

## 8. 状态指示电路

### 7.1 LED指示

```
电源指示:
VDD ── R4 (1KΩ) ── LED2 (红色) ── GND

端口状态指示:
端口1状态: STM32 PF0 ── R5 (1KΩ) ── LED3 (绿色) ── GND
端口2状态: STM32 PF1 ── R6 (1KΩ) ── LED4 (绿色) ── GND
端口3状态: STM32 PF2 ── R7 (1KΩ) ── LED5 (绿色) ── GND
端口4状态: STM32 PF3 ── R8 (1KΩ) ── LED6 (绿色) ── GND
端口5状态: STM32 PF5 ── R10 (1KΩ) ── LED8 (黄色) ── GND

通信状态:
STM32 PF4 ── R9 (1KΩ) ── LED7 (蓝色) ── GND
```

## 9. 保护电路

### 8.1 USB端口保护

```
每个USB端口的保护电路:

VBUS保护:
VBUS ── F2 (自恢复保险丝 500mA) ── 端口VBUS

数据线保护:
D+ ── TVS1 (双向TVS管) ── GND
D- ── TVS2 (双向TVS管) ── GND

ESD保护:
D+/D- ── ESD保护阵列 ── GND
```

### 8.2 电源保护

```
输入电源保护:
VBUS ── F1 (2A保险丝) ── D1 (肖特基二极管) ── VIN
                          │
                          TVS3 (单向TVS管)
                          │
                         GND
```

## 10. PCB布局要点

### 9.1 层叠结构

```
4层PCB层叠:
Layer 1: 信号层 (元件面)
Layer 2: 地层 (GND)
Layer 3: 电源层 (VDD)
Layer 4: 信号层 (焊接面)
```

### 9.2 关键信号处理

1. **USB3.0差分信号**：
   - 阻抗控制：90Ω±10%
   - 等长处理：±0.1mm
   - 最小弯曲半径：3倍线宽

2. **时钟信号**：
   - 晶振靠近MCU放置
   - 时钟走线尽量短
   - 避免跨越分割

3. **电源完整性**：
   - 多点去耦
   - 电源平面完整
   - 适当的过孔密度

### 9.3 EMC设计

1. **屏蔽措施**：
   - 敏感信号屏蔽
   - 适当的接地过孔
   - 边缘包地处理

2. **滤波设计**：
   - 电源入口滤波
   - 信号线滤波
   - 共模电感应用

---

*本原理图设计为详细技术方案，实际PCB设计时需要根据具体器件规格书进行细化调整。*